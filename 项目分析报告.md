# 项目分析报告

## 项目概述

这是一个**内容账号数据分析 + AI 辅助决策系统**，用于分析社交媒体（如小红书）笔记数据，并通过 AI 生成优化建议。

**核心业务流程：**
```
用户登录 -> 上传Excel数据 -> 数据解析入库 -> 数据分析(非AI) -> AI生成建议 -> 展示结果 -> 导出报告
```

## 技术栈详情

### 后端技术栈
- **框架**: FastAPI 0.109.0
- **数据库**: PostgreSQL 15 (asyncpg 驱动)
- **ORM**: SQLAlchemy 2.0.25
- **数据迁移**: Alembic 1.13.1
- **异步任务**: Celery 5.3.6 + Redis 7
- **认证**: JWT (python-jose) + BCrypt
- **数据处理**: pandas 2.2.0 + openpyxl 3.1.2 + numpy 1.26.3
- **HTTP客户端**: httpx 0.26.0
- **AI Providers**: DeepSeek、OpenAI、iFlow (Kimi)

### 前端技术栈
- **框架**: Vue 3.4.15 + TypeScript 5.3.3
- **构建工具**: Vite 5.0.11
- **UI组件库**: Element Plus 2.5.3
- **状态管理**: Pinia 2.1.7
- **路由**: Vue Router 4.2.5
- **HTTP客户端**: Axios 1.6.5
- **图表**: ECharts 5.4.3 + vue-echarts 6.6.8
- **日期处理**: dayjs 1.11.10

### 部署技术栈
- **容器化**: Docker + Docker Compose
- **反向代理**: Nginx
- **数据库**: PostgreSQL 15
- **缓存/队列**: Redis 7

## 架构设计

```
架构图：
┌─────────────────────────────────────────────────────────────────┐
│                           前端 (Vue3)                            │
│  LoginView | DatasetsView | AnalysesView | SettingsView       │
└───────────────────────────┬─────────────────────────────────────┘
                            │ HTTP/REST API
┌───────────────────────────┴─────────────────────────────────────┐
│                       后端 (FastAPI)                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  API Routes  │──│   Services   │──│   Models     │         │
│  │  /api/v1/*   │  │  Business    │  │  SQLAlchemy  │         │
│  └──────────────┘  └──────────────┘  └──────┬───────┘         │
│         │                  │                  │                 │
│         │                  │          ┌───────┴───────┐        │
│         │                  │          │  PostgreSQL   │        │
│         │                  │          └───────────────┘        │
│         │                  │                                   │
│         │         ┌────────┴────────┐                          │
│         │         │  Celery Tasks   │                          │
│         │         │  dataset_tasks  │                          │
│         │         │  analysis_tasks │                          │
│         │         │  ai_tasks       │                          │
│         │         └────────┬────────┘                          │
│         │                  │                                   │
│         │         ┌────────┴────────┐                          │
│         │         │     Redis       │                          │
│         │         │  (Queue/Cache)  │                          │
│         │         └─────────────────┘                          │
│         │                                                      │
│  ┌──────┴──────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   AI Layer  │  │  Analysis    │  │    Utils     │         │
│  │  DeepSeek   │  │  Processor   │  │   Excel      │         │
│  │  OpenAI     │  │  Calculator  │  │   Export     │         │
│  │  iFlow      │  │  Anomaly     │  │              │         │
│  └─────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## 目录结构说明

### 后端结构 (/backend)
```
backend/
├── app/
│   ├── api/               # API 路由层
│   │   ├── deps.py        # 依赖注入 (get_current_user)
│   │   └── v1/            # API v1 版本
│   │       ├── auth.py    # 认证接口: POST /register, /login, GET /me
│   │       ├── datasets.py    # 数据集接口: 上传、列表、详情、删除
│   │       ├── analyses.py    # 分析接口: 创建、列表、详情、触发AI
│   │       ├── posts.py       # 笔记接口: 获取详情
│   │       ├── exports.py     # 导出接口: 创建导出、下载
│   │       └── settings.py    # 设置接口: AI配置、测试连接
│   ├── core/              # 核心配置
│   │   ├── config.py      # 环境变量和配置管理
│   │   ├── security.py    # JWT/密码加密
│   │   └── exceptions.py  # 自定义异常
│   ├── models/            # 数据库模型
│   │   ├── user.py        # User: id, username, email, hashed_password
│   │   ├── dataset.py     # Dataset: id, name, file_path, status, row_count
│   │   ├── post.py        # Post: data_id, publish_time, 内容字段, 指标字段
│   │   ├── analysis.py    # Analysis, AnalysisResult, AIOutput
│   │   ├── export.py      # Export: id, format, status, file_path
│   │   └── user_settings.py # UserSettings: ai_provider, api_keys
│   ├── schemas/           # Pydantic 模型
│   │   ├── user.py
│   │   ├── dataset.py
│   │   ├── analysis.py
│   │   ├── settings.py
│   │   └── common.py      # ResponseModel
│   ├── services/          # 业务逻辑层
│   │   ├── ai_service.py
│   │   ├── analysis_service.py
│   │   └── export_service.py
│   ├── analysis/          # 数据分析模块 (非AI)
│   │   ├── processor.py   # DataProcessor: Excel解析、数据清洗
│   │   ├── calculator.py  # MetricsCalculator: 统计量计算
│   │   ├── anomaly.py     # AnomalyDetector: 异常检测
│   │   └── aggregator.py  # AnalysisAggregator: 整合所有分析
│   ├── ai/                # AI Provider 抽象层
│   │   ├── base.py        # BaseAIProvider, AIResponse
│   │   ├── deepseek.py    # DeepSeek Provider
│   │   ├── openai.py      # OpenAI Provider
│   │   ├── iflow.py       # iFlow Provider (Kimi)
│   │   ├── factory.py     # AIProviderFactory
│   │   └── prompts.py     # Prompt 模板
│   ├── tasks/             # Celery 异步任务
│   │   ├── celery_app.py  # Celery 配置
│   │   ├── dataset_tasks.py
│   │   ├── analysis_tasks.py
│   │   ├── ai_tasks.py
│   │   └── export_tasks.py
│   ├── utils/             # 工具函数
│   │   └── excel.py       # Excel 读取和验证
│   ├── db/                # 数据库
│   │   ├── base.py        # Base, async_session_maker
│   │   └── session.py
│   └── main.py            # FastAPI 应用入口
├── alembic/               # 数据库迁移
│   └── versions/
│       ├── 001_initial.py      # 初始化所有表
│       └── 002_add_perf_indexes.py  # 性能索引
├── scripts/               # 脚本
│   ├── init_db.py         # 初始化数据库
│   ├── create_user.py     # 创建测试用户
│   └── add_iflow_columns.py  # 添加 iFlow 字段
├── uploads/               # 上传文件目录
│   └── exports/           # 导出文件目录
├── requirements.txt
├── Dockerfile
└── .env.example
```

### 前端结构 (/frontend)
```
frontend/
├── src/
│   ├── api/               # API 请求封装
│   │   ├── index.ts       # Axios 实例配置
│   │   ├── auth.ts        # 认证 API
│   │   ├── datasets.ts    # 数据集 API
│   │   ├── analyses.ts    # 分析 API
│   │   ├── exports.ts     # 导出 API
│   │   └── settings.ts    # 设置 API
│   ├── assets/            # 静态资源
│   │   └── styles/
│   ├── components/        # 通用组件
│   │   └── layout/
│   ├── stores/            # Pinia 状态管理
│   │   ├── auth.ts        # 认证状态
│   │   ├── dataset.ts     # 数据集状态
│   │   └── analysis.ts    # 分析状态
│   ├── router/            # 路由配置
│   │   └── index.ts
│   ├── types/             # TypeScript 类型定义
│   │   └── index.ts
│   ├── views/             # 页面组件
│   │   ├── LoginView.vue              # 登录页
│   │   ├── DatasetsView.vue          # 数据集列表页
│   │   ├── AnalysesView.vue          # 分析列表页
│   │   ├── AnalysisConfigView.vue    # 分析配置页
│   │   ├── AnalysisResultView.vue    # 分析结果页
│   │   ├── PostDetailView.vue        # 笔记详情页
│   │   ├── ExportView.vue            # 导出页
│   │   └── SettingsView.vue          # 设置页
│   ├── App.vue
│   └── main.ts
├── public/
├── package.json
├── vite.config.ts
├── tsconfig.json
└── Dockerfile
```

## 核心功能模块分析

### 5.1 数据处理模块

**DataProcessor** (`backend/app/analysis/processor.py`)

```python
# Excel 列名映射
COLUMN_MAPPING = {
    'data_id': 'data_id',
    '发文时间': 'publish_time',
    '发文链接': 'publish_link',
    '内容形式': 'content_type',
    '发文类型': 'post_type',
    '素材来源': 'source',
    '款式信息': 'style_info',
    '7天阅读/播放': 'read_7d',
    '7天互动': 'interact_7d',
    '7天好物访问': 'visit_7d',
    '7天好物想要': 'want_7d',
    '14天阅读/播放': 'read_14d',
    '14天互动': 'interact_14d',
    '14天好物访问': 'visit_14d',
    '14天好物想要': 'want_14d',
}

# 处理流程
def process(self) -> pd.DataFrame:
    self.rename_columns()      # 重命名列
    self.clean_numeric_columns()  # 清洗数值型列
    self.parse_datetime()       # 解析日期时间
    self.handle_missing_values()  # 处理缺失值
    return self.processed_df
```

### 5.2 指标计算模块

**MetricsCalculator** (`backend/app/analysis/calculator.py`)

```python
# 计算基础统计量
def calculate_basic_stats(self) -> Dict[str, Dict[str, float]]:
    # 对每个指标计算: mean, median, std, min, max, q25, q75, q10, q90, count

# 与基准比较
def compare_to_baseline(self, row: pd.Series, baseline: str = 'mean') -> Dict[str, str]:
    # 计算与均值的百分比差异

# 获取百分位排名
def get_percentile_rank(self, row: pd.Series) -> Dict[str, float]:
    # 计算每个指标在数据集中的百分位排名
```

### 5.3 异常检测模块

**AnomalyDetector** (`backend/app/analysis/anomaly.py`)

```python
def detect_anomalies(self, row: pd.Series) -> Dict[str, Any]:
    # 检测表现突出的指标 (>= 90分位数)
    # 检测表现较差的指标 (<= 10分位数)

def determine_performance(self, row: pd.Series, primary_metrics: List[str] = None) -> str:
    # 判断整体表现: 优秀(>=1.5x) / 正常(>=1.0x) / 偏低(>=0.5x) / 较差(<0.5x)
```

### 5.4 AI Provider 抽象层

**BaseAIProvider** (`backend/app/ai/base.py`)

```python
@dataclass
class AIResponse:
    summary: str
    strengths: list
    weaknesses: list
    suggestions: list
    raw_response: str
    model_name: str
    tokens_used: Optional[Dict[str, int]] = None

class BaseAIProvider(ABC):
    @abstractmethod
    async def generate(self, prompt: str) -> str: pass

    @abstractmethod
    async def analyze_post(self, input_data: Dict[str, Any]) -> AIResponse: pass
```

**iFlow Provider** (`backend/app/ai/iflow.py`)

```python
class IFlowProvider(BaseAIProvider):
    DEFAULT_BASE_URL = "https://apis.iflow.cn/v1"
    DEFAULT_MODEL = "kimi-k2-0905"

    async def analyze_post(self, input_data: Dict[str, Any]) -> AIResponse:
        # 调用 POST {base_url}/chat/completions
        # 解析响应: choices[0].message.content
        # 提取 tokens: usage.prompt_tokens / completion_tokens / total_tokens

    @classmethod
    async def test_connection(cls, api_key: str, ...) -> Dict[str, Any]:
        # 真实请求测试连接
        # model="kimi-k2-0905", messages=[{"role":"user","content":"ping"}]
        # 处理各种错误码: 401/403/429/5xx
```

**AIProviderFactory** (`backend/app/ai/factory.py`)

```python
_providers = {
    'deepseek': DeepSeekProvider,
    'openai': OpenAIProvider,
    'iflow': IFlowProvider
}

def create(cls, provider_name: Optional[str] = None, api_key: Optional[str] = None):
    # 根据名称创建对应的 Provider 实例
    # 处理不同 Provider 的 API Key 获取逻辑
```

### 5.5 Prompt 模板

**prompts.py** (`backend/app/ai/prompts.py`)

```python
SYSTEM_PROMPT = """你是一个专业的内容运营分析师..."""

ANALYSIS_PROMPT_TEMPLATE = """请分析以下笔记的表现数据...

## 笔记信息
- 内容形式：{content_type}
- 发文类型：{post_type}
- 款式信息：{style_info}

## 数据分析结果
- 整体表现：{performance}
- 表现突出的指标：{highlight_metrics}
- 表现较差的指标：{problem_metrics}
- 与平均值对比：{compare_to_avg}

请严格按照以下JSON格式输出：
```json
{
    "summary": "一句话总结",
    "strengths": ["优点1", "优点2"],
    "weaknesses": ["问题1", "问题2"],
    "suggestions": ["建议1", "建议2", "建议3"]
}
```
"""
```

## 数据库设计

### 数据库表结构

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `users` | 用户表 | id (UUID), username, email, hashed_password, is_active |
| `user_settings` | 用户设置表 | user_id, ai_provider, deepseek_api_key, openai_api_key, iflow_api_key, iflow_model |
| `datasets` | 数据集表 | id, user_id, name, file_path, status (pending/processing/completed/failed), row_count |
| `posts` | 笔记表 | id, dataset_id, data_id, publish_time, content_type, post_type, 指标字段 (7天/14天) |
| `analyses` | 分析任务表 | id, dataset_id, user_id, status (pending/analyzing/ai_processing/completed/failed), config, progress |
| `analysis_results` | 分析结果表 | id, analysis_id, post_id, performance, result_data (JSON) |
| `ai_outputs` | AI输出表 | id, analysis_result_id, summary, strengths, weaknesses, suggestions, model_name, tokens_used |
| `exports` | 导出记录表 | id, analysis_id, user_id, file_path, format (excel/pdf/json), status |

### 数据库关系

```
users (1) ──────< (N) datasets
users (1) ──────< (N) analyses
users (1) ──────< (N) exports
users (1) ──────< (1) user_settings

datasets (1) ──────< (N) posts
datasets (1) ──────< (N) analyses

analyses (1) ──────< (N) analysis_results
analyses (1) ──────< (N) exports

posts (1) ──────< (N) analysis_results
analysis_results (1) ──────< (1) ai_outputs
```

### 性能索引

**002_add_perf_indexes.py** 定义了以下索引：
- `ix_datasets_user_id_created_at`: 按用户和时间查询数据集
- `ix_posts_dataset_id`: 按数据集查询笔记
- `ix_analyses_user_id_created_at`: 按用户和时间查询分析
- `ix_analyses_user_id_dataset_id_created_at`: 组合查询
- `ix_analysis_results_analysis_id_created_at`: 按分析查询结果
- `ix_analysis_results_analysis_id_performance`: 按表现筛选
- `ix_analysis_results_analysis_id_post_id`: 关联查询
- `ix_exports_user_id_created_at`: 按用户查询导出

## API 接口设计

### 认证接口 (`/api/v1/auth`)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/register` | 用户注册 |
| POST | `/login` | 用户登录 (返回 JWT token) |
| GET | `/me` | 获取当前用户信息 |

### 数据集接口 (`/api/v1/datasets`)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/upload` | 上传 Excel 文件 |
| GET | `` | 获取数据集列表 (分页) |
| GET | `/{id}` | 获取数据集详情 |
| DELETE | `/{id}` | 删除数据集 |

### 分析接口 (`/api/v1/analyses`)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `` | 创建分析任务 |
| GET | `` | 获取分析列表 |
| GET | `/{id}` | 获取分析详情 |
| GET | `/{id}/results` | 获取分析结果 (可按 performance 筛选) |
| POST | `/{id}/ai` | 触发 AI 分析 |

### 笔记接口 (`/api/v1/posts`)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/{post_id}` | 获取笔记详情 |

### 导出接口 (`/api/v1/exports`)

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/analyses/{id}/export` | 创建导出任务 |
| GET | `/{id}/download` | 下载导出文件 |

### 设置接口 (`/api/v1/settings`)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `` | 获取用户设置 |
| PUT | `` | 更新用户设置 (AI provider, API keys) |
| POST | `/test-api-key` | 测试 API 密钥连接 (iFlow 真实请求) |

## 部署方式

### Docker Compose 配置

**docker-compose.yml**

```yaml
services:
  postgres:      # PostgreSQL 15 (端口 5433)
  redis:         # Redis 7 (端口 6380)
  backend:       # FastAPI (端口 8000)
  celery-worker: # Celery Worker
  frontend:      # Nginx + Vue (端口 80)
```

### 环境变量

**后端环境变量**:
```bash
DATABASE_URL=postgresql+asyncpg://postgres:postgres@127.0.0.1:5433/content_analytics
REDIS_URL=redis://127.0.0.1:6380/0
SECRET_KEY=your-secret-key
DEEPSEEK_API_KEY=sk-xxx
OPENAI_API_KEY=sk-xxx
```

**前端环境变量**:
```bash
VITE_API_BASE_URL=http://localhost:8000/api/v1
```

### 启动流程

**开发环境启动**:
1. 启动基础服务: `docker-compose -f docker-compose.dev.yml up -d`
2. 初始化数据库: `python scripts/init_db.py`
3. 创建测试用户: `python scripts/create_user.py`
4. 启动后端: `uvicorn app.main:app --reload`
5. 启动 Celery: `celery -A app.tasks.celery_app worker --loglevel=info`
6. 启动前端: `npm run dev`

**生产部署**:
```bash
docker-compose up -d --build
```

## 其他重要信息

### 安全特性

- JWT 认证，token 有效期 24 小时
- 密码使用 BCrypt 加密
- API Key 不在日志中打印，错误信息不泄露敏感数据
- 用户数据隔离：只能访问自己的数据集和分析
- CORS 配置 (生产环境需限制具体域名)

### 异步任务处理

- Celery + Redis 实现异步任务队列
- 支持 Celery worker 不可用时降级为后台线程处理
- 任务状态追踪: pending -> analyzing -> ai_processing -> completed/failed
- 进度百分比显示: progress 字段 (0% - 100%)

### 文件上传

- 支持格式: .xlsx, .xls
- 最大文件大小: 10MB
- 流式写入，避免内存占用过大
- 文件存储路径: `uploads/{user_id}/{uuid}.xlsx`
- 导出文件路径: `uploads/exports/analysis_report_{uuid}_{timestamp}.xlsx`

### iFlow 集成特性

- 默认模型: `kimi-k2-0905`
- Base URL: `https://apis.iflow.cn/v1`
- 真实连接测试: 发送 ping 请求验证
- 错误处理: 401 (密钥无效), 403 (无权限), 429 (限流), 5xx (服务器错误)
- Token 统计: prompt_tokens, completion_tokens, total_tokens

### 前端特性

- 自动导入 Vue API 和 Element Plus 组件
- Axios 请求拦截器 (自动添加 Authorization header)
- Axios 响应拦截器 (统一错误处理，401 自动跳转登录)
- 网络错误自动重试 (GET 请求，最多 1 次)
- Pinia 状态持久化 (token 存储在 localStorage)

### 数据分析算法

- **基准计算**: 均值、中位数、分位数 (10%, 25%, 75%, 90%)
- **异常检测**: Top 10% (突出指标), Bottom 10% (问题指标)
- **表现评级**: 优秀 (>=1.5x), 正常 (>=1.0x), 偏低 (>=0.5x), 较差 (<0.5x)
- **分组统计**: 按内容类型、发文类型分组计算

---

**报告生成时间**: 2025年12月26日